# CloudFlare Assistant v5.6 版本更新

## 🎉 新增功能

### 1. 多域名管理（Zone）系统

#### 完整的 Zone 管理架构
- **多域名支持**：每个账号支持管理多个域名（Zone）
- **独立 Zone 数据库**：新增 Zone 实体表，支持完整的 CRUD 操作
- **选择状态记忆**：记录每个账号当前选中的域名

#### 从 API 自动获取域名
- **一键获取**：在账号编辑页面点击"从API获取域名"按钮
- **自动保存**：从 Cloudflare API 获取所有域名并保存到本地
- **域名信息**：包含域名名称、状态（active/pending）、类型等完整信息

#### 可视化域名管理界面
- **账号编辑页面**：
  - "从API获取域名" 按钮：自动拉取并保存域名列表
  - "管理域名" 按钮：打开域名选择对话框
- **域名选择对话框**：
  - 显示所有域名及状态（✓ active / ○ pending）
  - 标记当前选中的域名 [已选择]/[当前]
  - 单选方式快速切换域名
  - 提供"从API刷新"按钮更新域名列表

#### 智能切换体验
- **右上角切换按钮**：选择账号后自动弹出域名选择对话框
- **账号列表切换**：点击"设为默认账号"后自动提示选择域名
- **无域名友好提示**：账号无域名时提供引导，可跳转到编辑页面获取

#### 向后兼容设计
- **自动同步**：选择域名后自动更新 Account.zoneId 字段
- **无缝切换**：所有现有功能（Workers、Routes、R2等）无需修改即可使用选中的域名
- **数据迁移**：从 v5.5 升级时自动保留原有的 zoneId 配置

### 2. R2 自定义域管理增强

#### 自定义域创建功能
- **API 集成**：通过 Cloudflare API 创建 R2 自定义域绑定
- **添加域名**：在 R2 存储桶的自定义域列表中添加新域名
- **Zone ID 支持**：自动使用账号选中的 Zone ID 进行域名绑定
- **验证机制**：添加域名前验证账号是否已配置 Zone ID

#### R2 对话框导航优化
- **分层导航**：实现完整的对话框层级结构
  - 存储桶列表 → 对象列表 → 对象详情 → 操作菜单
  - 存储桶列表 → 自定义域列表 → 添加/删除域名
- **返回按钮**：所有对话框的"关闭/取消"改为"返回"
- **智能返回**：操作完成后自动返回父级对话框而非关闭全部
- **加载优化**：对象列表加载前显式等待数据加载完成
- **操作连贯性**：复制、下载、删除等操作后保持在对象列表

### 3. 数据库架构升级

#### Zone 表结构（v4 迁移）
```sql
CREATE TABLE zones (
    id TEXT PRIMARY KEY,              -- Zone ID
    accountId INTEGER NOT NULL,        -- 关联账号
    name TEXT NOT NULL,                -- 域名
    status TEXT NOT NULL,              -- active/pending
    type TEXT,                         -- full/partial
    paused INTEGER NOT NULL,           -- 是否暂停
    isSelected INTEGER NOT NULL,       -- 是否选中
    createdAt INTEGER NOT NULL,
    updatedAt INTEGER NOT NULL,
    FOREIGN KEY(accountId) REFERENCES accounts(id) ON DELETE CASCADE
)
```

#### 数据完整性
- **外键约束**：Zone 表与 Account 表建立外键关联
- **级联删除**：删除账号时自动删除关联的所有域名
- **索引优化**：accountId 字段建立索引提升查询性能

## 🎨 界面优化

### 账号编辑页面
- **域名管理区块**：新增独立的"域名管理（Zone）"区块
- **双按钮设计**：
  - "从API获取域名"：简洁的 Outlined 风格按钮
  - "管理域名"：与获取按钮并列，一致的设计风格
- **响应式布局**：两个按钮横向排列，等宽分布

### 域名选择对话框
- **清晰的视觉反馈**：
  - ✓ 标记活跃域名
  - ○ 标记待激活域名
  - [当前]/[已选择] 标记选中状态
- **三按钮布局**：
  - 正按钮：直接选择域名
  - 中性按钮："从API刷新"
  - 负按钮："取消/跳过"

### R2 对话框体验
- **统一的返回逻辑**：所有对话框使用一致的返回按钮
- **操作流畅性**：减少不必要的对话框关闭，保持操作连续性
- **加载状态反馈**：数据加载时显示等待状态

## 🔧 修复与优化

### 核心修复
- **对象列表加载**：修复 R2 对象列表有时不显示的问题
- **对话框状态**：修复对话框意外关闭导致的操作中断
- **数据同步**：确保域名选择后立即同步到所有相关功能
- **循环依赖**：解决 ZoneRepository 和 AccountRepository 的依赖注入问题

### 性能优化
- **延迟加载**：使用 Lazy 注入避免循环依赖
- **批量操作**：域名数据批量插入提升性能
- **索引优化**：关键查询字段添加数据库索引
- **状态管理**：优化 ViewModel 的状态流管理

### 代码质量
- **日志完善**：添加详细的操作日志便于调试
- **异常处理**：完善各种边界情况的异常处理
- **参数验证**：添加必要的参数验证和友好提示
- **注释补充**：为关键方法添加清晰的文档注释

## 📊 技术改进

### 新增组件
- **ZoneDao**：Zone 数据访问对象，提供完整的 CRUD 操作
- **ZoneRepository**：Zone 仓储层，封装业务逻辑和 API 调用
- **Zone API**：Cloudflare Zones API 接口集成

### 架构优化
- **MVVM 增强**：AccountViewModel 新增 Zone 管理相关状态和方法
- **仓储模式**：完善仓储层设计，保持代码解耦
- **依赖注入**：使用 Hilt 进行依赖管理，支持 Lazy 注入

### API 集成
- **GET /zones**：获取账号下所有域名
- **POST /accounts/{id}/r2/buckets/{name}/domains/custom**：创建 R2 自定义域

## 🔄 迁移说明

### 从 v5.5 升级
1. **自动迁移**：应用启动时自动执行数据库迁移（v3 → v4）
2. **数据保留**：现有账号的 zoneId 配置完整保留
3. **向后兼容**：所有现有功能正常工作，无需修改

### 建议操作
1. 升级后访问"账号管理"页面
2. 编辑账号，点击"从API获取域名"
3. 在"管理域名"中选择常用域名
4. 切换账号时会自动提示选择域名

## 📝 已知限制

- Zone API 需要相应的 API Token 权限（Zone:Read）
- R2 自定义域创建需要账号已配置有效的 Zone ID
- 首次使用多域名功能需要手动从 API 获取域名列表

## 🙏 特别说明

本版本重点优化了多账号、多域名场景下的使用体验，特别是：
- 简化了域名切换流程
- 完善了 R2 自定义域管理
- 提升了对话框操作的连贯性

感谢所有用户的反馈和建议！

---

**更新时间**：2025年12月19日  
**版本代码**：2025121901  
**适配系统**：Android 7.0+（API 25+）
