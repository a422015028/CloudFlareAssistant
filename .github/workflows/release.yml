name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v5.9)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Decode Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo $KEYSTORE_BASE64 | base64 -d > $GITHUB_WORKSPACE/app/keystore.jks
    
    - name: Build Release APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/app/keystore.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD
    
    - name: Get version info
      id: version
      run: |
        VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk -F'"' '{print $2}')
        VERSION_CODE=$(grep "versionCode" app/build.gradle.kts | awk -F'=' '{print $2}' | tr -d ' ')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        # è·å– tagï¼ˆpush tag æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "tag_name=${{ inputs.version_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Rename APK
      run: |
        mv app/build/outputs/apk/release/app-release.apk \
           app/build/outputs/apk/release/CloudFlareAssistant-v${{ steps.version.outputs.version_name }}.apk
    
    - name: Prepare Release Notes
      id: release_notes
      run: |
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ release notes æ–‡ä»¶
        RELEASE_NOTES_FILE="RELEASE_NOTES_${TAG_NAME}.md"
        
        if [ -f "$RELEASE_NOTES_FILE" ]; then
          echo "ä½¿ç”¨ $RELEASE_NOTES_FILE ä½œä¸ºå‘å¸ƒè¯´æ˜"
          # è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å¤´éƒ¨
          {
            echo "## ğŸ‰ CloudFlare Assistant ${TAG_NAME} å‘å¸ƒ"
            echo ""
            echo "**ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version_name }}"
            echo "**Build**: ${{ steps.version.outputs.version_code }}"
            echo ""
            cat "$RELEASE_NOTES_FILE"
            echo ""
          } > release_notes.md
        else
          echo "æœªæ‰¾åˆ° $RELEASE_NOTES_FILEï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿"
          {
            echo "## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ"
            echo ""
            echo "**ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version_name }}"
            echo "**Build**: ${{ steps.version.outputs.version_code }}"
            echo ""
            echo "### ğŸ“¥ ä¸‹è½½"
            echo "ç‚¹å‡»ä¸‹æ–¹çš„ APK æ–‡ä»¶å³å¯ä¸‹è½½å®‰è£…ï¼ˆå·²ç­¾åï¼‰"
            echo ""
            echo "### ğŸ“¦ å®‰è£…è¦æ±‚"
            echo "- æœ€ä½ Android ç‰ˆæœ¬: 8.0 (API 26)"
            echo "- ç›®æ ‡ Android ç‰ˆæœ¬: 16 (API 36)"
            echo ""
            echo "### ğŸ” ç­¾åä¿¡æ¯"
            echo "æ­¤ç‰ˆæœ¬å·²ä½¿ç”¨å¼€å‘è€…è¯ä¹¦ç­¾åï¼Œå¯ä»¥ç›´æ¥å®‰è£…ä½¿ç”¨ã€‚"
          } > release_notes.md
        fi

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag_name }}
        files: app/build/outputs/apk/release/CloudFlareAssistant-v${{ steps.version.outputs.version_name }}.apk
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Send APK to Telegram
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
      run: |
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        VERSION_CODE="${{ steps.version.outputs.version_code }}"
        RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
        APK_FILE="app/build/outputs/apk/release/CloudFlareAssistant-v${VERSION_NAME}.apk"
        
        # è¯»å–å‘å¸ƒè¯´æ˜ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        RELEASE_NOTES_FILE="RELEASE_NOTES_${TAG_NAME}.md"
        if [ -f "$RELEASE_NOTES_FILE" ]; then
          # æå–ä¸»è¦åŠŸèƒ½ç‚¹ï¼ˆå‰20è¡Œï¼‰ï¼Œç§»é™¤ Markdown æ ¼å¼ï¼Œè½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
          NOTES=$(head -n 20 "$RELEASE_NOTES_FILE" | \
            sed 's/^#\+\s*//' | \
            sed 's/\*\*//g' | \
            sed 's/`//g' | \
            sed 's/</\&lt;/g' | \
            sed 's/>/\&gt;/g' | \
            sed 's/&/\&amp;/g' | \
            sed 's/"/\&quot;/g')
        else
          NOTES="æ–°ç‰ˆæœ¬å‘å¸ƒ"
        fi
        
        # æ„å»º Telegram æ¶ˆæ¯
        CAPTION="ğŸ‰ <b>CloudFlare Assistant ${TAG_NAME} å‘å¸ƒ</b>
        
        ğŸ“± <b>ç‰ˆæœ¬ä¿¡æ¯</b>
        â€¢ ç‰ˆæœ¬å·: ${VERSION_NAME}
        â€¢ Build: ${VERSION_CODE}
        â€¢ å‘å¸ƒæ—¥æœŸ: $(date +'%Yå¹´%mæœˆ%dæ—¥')
        
        ${NOTES}
        
        ğŸ”— <b>ç›¸å…³é“¾æ¥</b>
        <a href=\"${RELEASE_URL}\">ğŸ“„ æŸ¥çœ‹å®Œæ•´å‘å¸ƒè¯´æ˜</a>
        
        ğŸ“¦ <b>å®‰è£…è¦æ±‚</b>
        â€¢ æœ€ä½ç‰ˆæœ¬: Android 8.0 (API 26)
        â€¢ ç›®æ ‡ç‰ˆæœ¬: Android 16 (API 36)"
        
        # å‘é€ APK æ–‡ä»¶åˆ° Telegramï¼ˆæ”¯æŒè¯é¢˜ï¼‰
        echo "ğŸ“¤ æ­£åœ¨å‘é€ APK æ–‡ä»¶åˆ° Telegram..."
        
        if [ -n "$TELEGRAM_TOPIC_ID" ]; then
          # å‘é€åˆ°æŒ‡å®šè¯é¢˜
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
            -F "chat_id=${TELEGRAM_CHAT_ID}" \
            -F "message_thread_id=${TELEGRAM_TOPIC_ID}" \
            -F "document=@${APK_FILE}" \
            -F "caption=${CAPTION}" \
            -F "parse_mode=HTML"
        else
          # å‘é€åˆ°ç¾¤ç»„ä¸»èŠå¤©
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
            -F "chat_id=${TELEGRAM_CHAT_ID}" \
            -F "document=@${APK_FILE}" \
            -F "caption=${CAPTION}" \
            -F "parse_mode=HTML"
        fi
        
        echo "âœ… APK æ–‡ä»¶å’Œå‘å¸ƒè¯´æ˜å·²å‘é€åˆ° Telegram"
